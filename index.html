<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Two-Week Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts for Lexend -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Lexend', Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #121212;
      color: #e0e0e0;
    }
    .controls { margin: 0.5rem 0; }
    .controls button {
      background: #333;
      color: #e0e0e0;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 600;
      font-size: 1rem;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }
    .day {
      border: 1px solid #333;
      background: #1e1e1e;
      min-height: 150px;
      padding: 5px;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .day h3 {
      margin: 0 0 5px;
      font-size: 20pt;
      color: #e0e0e0;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: center;
      pointer-events: none;
    }
    .tile {
      min-height: 5rem;
      padding: 0.5rem;
      margin: 0;
      border-radius: 6px;
      position: relative;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      overflow: visible;
      word-break: break-word;
      z-index: 1;
      box-shadow: 0 2px 8px #0002;
      transition: box-shadow 0.2s;
    }
    .tile.drag-over {
      outline: 2px dashed #4099ff;
      box-shadow: 0 2px 16px #4099ff88;
      z-index: 10;
    }
    .tile.color-0 { background: #ffdcdc; }
    .tile.color-1 { background: #fff4c2; }
    .tile.color-2 { background: #dcffe4; }
    .tile.color-3 { background: #dceaff; }
    .tile.color-4 { background: #f0dcff; }
    .tile.color-5 { background: #ffebdc; }

    .calendar .tile { width: 100%; }
    .holding-area .tile { width: calc((100% - 3rem) / 7); }

    .tile-content {
      width: 100%;
      text-align: center;
      outline: none;
      background: transparent;
      border: none;
      font-size: 16pt;
      color: #000;
      min-height: 2.5rem;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 300;
      word-break: break-word;
      cursor: pointer;
    }
    .tile-content[contenteditable="true"] {
      background: #f9f9f9;
      color: #222;
      cursor: text;
    }
    .tile .del-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      color: #000;
      font-size: 22px;
      font-weight: bold;
      line-height: 1;
      cursor: pointer;
      z-index: 10;
      padding: 0 2px;
    }
    .tile .color-btn {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: none;
      border: none;
      font-size: 20px;
      color: #222;
      cursor: pointer;
      z-index: 10;
      padding: 0 2px;
    }
    .holding-area {
      margin-top: 2rem;
      padding: 1rem;
      background: #2a2a2a;
      min-height: 120px;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      border-radius: 8px;
    }
    a {
      color: #1266cc;
      word-break: break-all;
    }
    .drop-zone {
      height: 22px;
      margin: 2px 0;
      background: transparent;
      transition: background 0.2s;
    }
    .drop-zone.drag-over {
      background: #4099ff44;
      border-radius: 8px;
    }
    /* Extra space between tiles for easier touch/mouse drop */
    .tile + .drop-zone {
      margin-bottom: 12px;
    }
  </style>
  <!-- Firebase SDKs (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAEpv0ZHT3fwo9aIsJKyzvk9EPtG70HNkk",
      authDomain: "calendartiles.firebaseapp.com",
      projectId: "calendartiles",
      storageBucket: "calendartiles.appspot.com",
      messagingSenderId: "960760935764",
      appId: "1:960760935764:web:4eef1929b9c40416d984c1",
      measurementId: "G-S39474K89Y"
    };

    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const docRef = doc(db, "calendarState", "shared");

    // Ensure document exists on first load
    (async () => {
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        await setDoc(docRef, { state: {} });
      }
    })();

    const days = [
      'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
    ];
    const dates = [
      'July 27', 'July 28', 'July 29', 'July 30', 'July 31', 'August 1', 'August 2',
      'August 3', 'August 4', 'August 5', 'August 6', 'August 7', 'August 8', 'August 9'
    ];
    const pastelColors = [0, 1, 2, 3, 4, 5];

    let state = {};

    // --- DOM references
    const calendarEl = document.createElement("div");
    calendarEl.id = "calendar";
    calendarEl.className = "calendar";
    document.body.insertBefore(calendarEl, document.body.children[0]);
    const holdingAreaEl = document.getElementById("holdingArea");

    // --- Helper: linkify function ---
    function linkify(html) {
      return html.replace(
        /(https?:\/\/[^\s<]+)/g,
        url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
      );
    }

    // --- Calendar UI functions ---
    function renderCalendar() {
  calendarEl.innerHTML = "";
  for (let i = 0; i < 14; i++) {
    const dayBox = document.createElement("div");
    dayBox.className = "day";
    dayBox.dataset.date = dates[i];
    // Remove the allowDrop assignment!
    dayBox.ondrop = (e) => handleDropZoneDrop(e, dates[i], 0);

    const title = document.createElement("h3");
    title.innerHTML = `${days[i % 7]}<br>${dates[i]}`;
    dayBox.appendChild(title);

    calendarEl.appendChild(dayBox);
  }
}


    function createTile(text = "New Activity", color = 0, location = null) {
      const id = `tile-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      const tileData = { id, text, color, location, order: Date.now() };
      state[id] = tileData;
      syncToFirestore();
    }

    // Helper to get tiles in location sorted by .order
    function getTilesInLocation(loc) {
      return Object.values(state)
        .filter(t => t.location === loc)
        .sort((a, b) => (a.order || 0) - (b.order || 0));
    }

    function renderTile(data, parent, idx, allTilesHere) {
      // Drop-zone above this tile
      const dropAbove = document.createElement('div');
      dropAbove.className = 'drop-zone';
      dropAbove.addEventListener('dragover', e => { e.preventDefault(); dropAbove.classList.add('drag-over'); });
      dropAbove.addEventListener('dragleave', e => dropAbove.classList.remove('drag-over'));
      dropAbove.addEventListener('drop', e => {
        e.preventDefault();
        dropAbove.classList.remove('drag-over');
        const draggedId = e.dataTransfer.getData('text/plain');
        if (state[draggedId] && draggedId !== data.id) {
          // Insert at this position
          allTilesHere.splice(idx, 0, state[draggedId]);
          // Remove dups
          let seen = new Set();
          let filtered = allTilesHere.filter(t => seen.has(t.id) ? false : seen.add(t.id));
          filtered.forEach((t, i) => t.order = Date.now() + i);
          state[draggedId].location = data.location;
          syncToFirestore();
        }
      });
      parent.appendChild(dropAbove);

      const tile = document.createElement("div");
      tile.className = `tile color-${data.color}`;
      tile.draggable = true;
      tile.dataset.id = data.id;

      let isEditing = false;

      // Editable content area
      const content = document.createElement("div");
      content.className = "tile-content";
      content.spellcheck = true;

      function renderContent() {
        if (isEditing) {
          content.contentEditable = true;
          content.innerText = data.text.replace(/<br\s*\/?>/gi, "\n");
          content.focus();
        } else {
          content.contentEditable = false;
          let html = (data.text || "").replace(/\n/g, "<br>");
          content.innerHTML = linkify(html);
        }
      }
      renderContent();

      // Double-click or double-tap to edit
      let lastTap = 0;
      content.addEventListener("dblclick", () => {
        isEditing = true;
        renderContent();
      });
      content.addEventListener("touchend", (e) => {
        const now = Date.now();
        if (now - lastTap < 400) {
          isEditing = true;
          renderContent();
        }
        lastTap = now;
      });

      // Finish editing on blur only
      content.addEventListener("blur", () => {
        if (isEditing) {
          isEditing = false;
          state[data.id].text = content.innerText.replace(/\n/g, "\n");
          syncToFirestore();
          renderContent();
        }
      });

      content.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          content.blur();
        }
        // Shift+Enter = newline (default behavior)
      });

      // Delete button
      const del = document.createElement("button");
      del.className = "del-btn";
      del.type = "button";
      del.innerText = "Ã—";
      del.title = "Delete";
      del.onclick = (e) => {
        e.stopPropagation();
        delete state[data.id];
        syncToFirestore();
      };

      // Color cycle button
      const colorBtn = document.createElement("button");
      colorBtn.className = "color-btn";
      colorBtn.type = "button";
      colorBtn.innerText = "ðŸŽ¨";
      colorBtn.title = "Change Color";
      colorBtn.onclick = (e) => {
        e.stopPropagation();
        state[data.id].color = (state[data.id].color + 1) % pastelColors.length;
        syncToFirestore();
      };

      // Drag logic
      tile.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", data.id);
        setTimeout(() => tile.classList.add("drag-over"), 0);
      });
      tile.addEventListener("dragend", (e) => {
        tile.classList.remove("drag-over");
      });

      // Highlight tile on drag over
      tile.addEventListener("dragover", (e) => {
        e.preventDefault();
        tile.classList.add("drag-over");
      });
      tile.addEventListener("dragleave", (e) => {
        tile.classList.remove("drag-over");
      });

      // Drop directly on tile (insert here)
      tile.addEventListener("drop", e => {
        e.preventDefault();
        tile.classList.remove("drag-over");
        const draggedId = e.dataTransfer.getData("text/plain");
        if (state[draggedId] && draggedId !== data.id) {
          // Insert above (by default) this tile
          allTilesHere.splice(idx, 0, state[draggedId]);
          let seen = new Set();
          let filtered = allTilesHere.filter(t => seen.has(t.id) ? false : seen.add(t.id));
          filtered.forEach((t, i) => t.order = Date.now() + i);
          state[draggedId].location = data.location;
          syncToFirestore();
        }
      });

      tile.appendChild(content);
      tile.appendChild(del);
      tile.appendChild(colorBtn);

      parent.appendChild(tile);
    }

    // Drop zone at the very end (bottom) of a day/holding area
    function renderDropZoneAtEnd(parent, location, allTilesHere) {
      const dropEnd = document.createElement('div');
      dropEnd.className = 'drop-zone';
      dropEnd.addEventListener('dragover', e => { e.preventDefault(); dropEnd.classList.add('drag-over'); });
      dropEnd.addEventListener('dragleave', e => dropEnd.classList.remove('drag-over'));
      dropEnd.addEventListener('drop', e => {
        e.preventDefault();
        dropEnd.classList.remove('drag-over');
        const draggedId = e.dataTransfer.getData('text/plain');
        if (state[draggedId]) {
          allTilesHere.push(state[draggedId]);
          let seen = new Set();
          let filtered = allTilesHere.filter(t => seen.has(t.id) ? false : seen.add(t.id));
          filtered.forEach((t, i) => t.order = Date.now() + i);
          state[draggedId].location = location;
          syncToFirestore();
        }
      });
      parent.appendChild(dropEnd);
    }

    // Drop handler for empty days/holding area
    function handleDropZoneDrop(e, location, idx) {
      e.preventDefault();
      const draggedId = e.dataTransfer.getData('text/plain');
      if (state[draggedId]) {
        state[draggedId].location = location;
        state[draggedId].order = Date.now();
        syncToFirestore();
      }
    }

    function renderAll() {
      holdingAreaEl.innerHTML = '';
      renderCalendar();

      // Holding area tiles (null location)
      let tilesInHolding = getTilesInLocation(null);
      tilesInHolding.forEach((t, idx) => renderTile(t, holdingAreaEl, idx, tilesInHolding));
      renderDropZoneAtEnd(holdingAreaEl, null, tilesInHolding);

      // For each day
      dates.forEach(date => {
        const dayBox = [...calendarEl.children].find(d => d.dataset.date === date);
        if (!dayBox) return;
        let tilesInDay = getTilesInLocation(date);
        tilesInDay.forEach((t, idx) => renderTile(t, dayBox, idx, tilesInDay));
        renderDropZoneAtEnd(dayBox, date, tilesInDay);
      });
    }

    // --- Firestore Sync ---
    async function syncToFirestore() {
      await setDoc(docRef, { state });
    }

    // Listen to Firestore changes
    onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists() && docSnap.data().state) {
        state = docSnap.data().state;
        renderAll();
      }
    });

    // --- UI BUTTON: Create tile ---
    window.createTile = createTile;

    // Initial render
    renderAll();

    // Utility: close mobile keyboard by tapping elsewhere
    document.body.addEventListener("touchstart", (e) => {
      if (!e.target.closest('.tile-content')) {
        document.activeElement.blur();
      }
    });
  </script>
</head>
<body>
  <h3>Holding Area</h3>
  <div class="controls">
    <button onclick="createTile()">âž• Create Tile</button>
  </div>
  <div id="holdingArea" class="holding-area"></div>
</body>
</html>
