<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Two-Week Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts for Lexend -->
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;600&display=swap" rel="stylesheet">
  <!-- Sortable.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Lexend', Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #121212;
      color: #e0e0e0;
    }
    .controls { margin: 0.5rem 0; }
    .controls button {
      background: #333;
      color: #e0e0e0;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 600;
      font-size: 1rem;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    .day {
      border: 1px solid #333;
      background: #1e1e1e;
      min-height: 150px;
      padding: 5px;
      display: flex;
      flex-direction: column;
      border-radius: 8px;
    }
    .day h3 {
      margin: 0 0 5px;
      font-size: 20pt;
      color: #e0e0e0;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-align: center;
    }
    .tile-list {
      flex: 1;
      min-height: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: 5px;
      padding-top: 5px;
    }
    .tile {
      min-height: 5rem;
      padding: 0.5rem;
      margin: 0;
      border-radius: 6px;
      position: relative;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      word-break: break-word;
      box-shadow: 0 2px 8px #0002;
      transition: box-shadow 0.15s, transform 0.15s;
      font-size: 12pt;
      font-family: 'Lexend', Arial, sans-serif;
      font-weight: 300;
      color: #000;
      cursor: grab;
    }
    .tile.color-0 { background: #ffdcdc; }
    .tile.color-1 { background: #fff4c2; }
    .tile.color-2 { background: #dcffe4; }
    .tile.color-3 { background: #dceaff; }
    .tile.color-4 { background: #f0dcff; }
    .tile.color-5 { background: #ffebdc; }
    .tile:active { cursor: grabbing; }
    .tile .del-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      background: none;
      border: none;
      color: #000;
      font-size: 22px;
      font-weight: bold;
      line-height: 1;
      cursor: pointer;
      z-index: 10;
      padding: 0 2px;
    }
    .tile .color-btn {
      position: absolute;
      bottom: 6px;
      right: 6px;
      background: none;
      border: none;
      font-size: 20px;
      color: #222;
      cursor: pointer;
      z-index: 10;
      padding: 0 2px;
    }
    .holding-area {
      margin-top: 0.5rem;
      padding: 1rem;
      background: #2a2a2a;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex-wrap: wrap;
      border-radius: 8px;
    }
    .holding-list {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      min-height: 5rem;
      width: 100%;
    }
    a { color: #1266cc; word-break: break-all; }
    .tile-editing { outline: 2px solid #007bff; background: #fffbe6 !important; }
    .sortable-chosen { box-shadow: 0 8px 16px #0004 !important; }
    .sortable-ghost { opacity: 0.4 !important; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAEpv0ZHT3fwo9aIsJKyzvk9EPtG70HNkk",
      authDomain: "calendartiles.firebaseapp.com",
      projectId: "calendartiles",
      storageBucket: "calendartiles.appspot.com",
      messagingSenderId: "960760935764",
      appId: "1:960760935764:web:4eef1929b9c40416d984c1",
      measurementId: "G-S39474K89Y"
    };

    // Use object for days (no nested arrays)
    function freshState() {
      const days = {};
      for (let i = 0; i < 14; i++) days[i] = [];
      return { days, holding: [] };
    }

    // Initialize Firebase and Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const docRef = doc(db, "calendarState", "shared");

    // Ensure document exists on first load
    (async () => {
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        await setDoc(docRef, freshState());
      }
    })();

    const daysOfWeek = [
      'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'
    ];
    const dates = [
      'July 27', 'July 28', 'July 29', 'July 30', 'July 31', 'August 1', 'August 2',
      'August 3', 'August 4', 'August 5', 'August 6', 'August 7', 'August 8', 'August 9'
    ];
    const pastelColors = [0, 1, 2, 3, 4, 5];

    let state = freshState();

    function linkify(html) {
      return html.replace(
        /(https?:\/\/[^\s<]+)/g,
        url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`
      );
    }

    function renderCalendar() {
      const calendarEl = document.getElementById("calendar");
      calendarEl.innerHTML = "";
      for (let i = 0; i < 14; i++) {
        const dayBox = document.createElement("div");
        dayBox.className = "day";
        dayBox.dataset.date = dates[i];

        const title = document.createElement("h3");
        title.innerHTML = `${daysOfWeek[i % 7]}<br>${dates[i]}`;
        dayBox.appendChild(title);

        const list = document.createElement("div");
        list.className = "tile-list";
        list.dataset.dayIndex = i;
        dayBox.appendChild(list);

        calendarEl.appendChild(dayBox);
      }
    }

    function renderAll() {
      renderCalendar();

      // --- HOLDING AREA ---
      const holdingList = document.getElementById("holdingList");
      if (holdingList.sortable) { holdingList.sortable.destroy(); holdingList.sortable = null; }
      holdingList.innerHTML = "";
      for (const tile of state.holding) {
        holdingList.appendChild(createTileElement(tile, null, "holding"));
      }
      holdingList.sortable = Sortable.create(holdingList, {
        group: "tiles",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        onEnd: function (evt) {
          let moved = removeTileFromAll(evt.item.dataset.id);
          state.holding.splice(evt.newIndex, 0, moved);
          syncToFirestore();
        }
      });

      // --- EACH CALENDAR DAY ---
      for (let i = 0; i < 14; i++) {
        const dayList = document.querySelector(`.tile-list[data-day-index='${i}']`);
        if (dayList.sortable) { dayList.sortable.destroy(); dayList.sortable = null; }
        dayList.innerHTML = "";
        for (const tile of state.days[i]) {
          dayList.appendChild(createTileElement(tile, i, "calendar"));
        }
        dayList.sortable = Sortable.create(dayList, {
          group: "tiles",
          animation: 150,
          ghostClass: "sortable-ghost",
          chosenClass: "sortable-chosen",
          onEnd: function (evt) {
            let moved = removeTileFromAll(evt.item.dataset.id);
            if (!Array.isArray(state.days[i])) state.days[i] = [];
            state.days[i].splice(evt.newIndex, 0, moved);
            syncToFirestore();
          }
        });
      }
    }

    function createTileElement(data, dayIndex, zoneType) {
      const tile = document.createElement("div");
      tile.className = `tile color-${data.color || 0}`;
      tile.dataset.id = data.id;
      tile.style.touchAction = "manipulation";

      let isEditing = false;

      const content = document.createElement("div");
      content.className = "tile-content";
      content.spellcheck = true;

      function renderContent() {
        if (isEditing) {
          content.contentEditable = true;
          content.innerText = data.text;
          content.classList.add('tile-editing');
          setTimeout(() => { content.focus(); }, 20);
        } else {
          content.contentEditable = false;
          content.innerHTML = linkify(data.text || "");
          content.classList.remove('tile-editing');
        }
      }
      renderContent();

      content.addEventListener("dblclick", (e) => {
        e.stopPropagation();
        isEditing = true;
        renderContent();
      });
      content.addEventListener("touchstart", (e) => {
        if (!isEditing && e.touches.length === 1) {
          let timeout = setTimeout(() => {
            isEditing = true;
            renderContent();
          }, 400);
          content.addEventListener("touchend", function cancel() { clearTimeout(timeout); content.removeEventListener("touchend", cancel); });
        }
      });
      content.addEventListener("blur", (e) => {
        if (isEditing) {
          isEditing = false;
          data.text = content.innerText.trim();
          syncToFirestore();
          renderContent();
        }
      });

      // Delete button
      const del = document.createElement("button");
      del.className = "del-btn";
      del.type = "button";
      del.innerText = "Ã—";
      del.title = "Delete";
      del.onclick = (e) => {
        e.stopPropagation();
        if (zoneType === "holding") {
          state.holding = (Array.isArray(state.holding) ? state.holding : []).filter(t => t.id !== data.id);
        } else if (typeof dayIndex === "number") {
          if (Array.isArray(state.days[dayIndex])) {
            state.days[dayIndex] = state.days[dayIndex].filter(t => t.id !== data.id);
          }
        }
        syncToFirestore();
      };

      // Color cycle button
      const colorBtn = document.createElement("button");
      colorBtn.className = "color-btn";
      colorBtn.type = "button";
      colorBtn.innerText = "ðŸŽ¨";
      colorBtn.title = "Change Color";
      colorBtn.onclick = (e) => {
        e.stopPropagation();
        data.color = ((data.color || 0) + 1) % pastelColors.length;
        syncToFirestore();
      };

      tile.appendChild(content);
      tile.appendChild(del);
      tile.appendChild(colorBtn);

      return tile;
    }

    function removeTileFromAll(id) {
      let moved;
      state.holding = (Array.isArray(state.holding) ? state.holding : []).filter(t => {
        if (t.id === id) moved = t;
        return t.id !== id;
      });
      for (let i = 0; i < 14; i++) {
        if (!Array.isArray(state.days[i])) state.days[i] = [];
        state.days[i] = state.days[i].filter(t => {
          if (t.id === id) moved = t;
          return t.id !== id;
        });
      }
      return moved;
    }

    async function syncToFirestore() {
      await setDoc(docRef, { days: state.days, holding: state.holding });
    }

    onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        // Defensive: all lists must be arrays
        const newDays = {};
        for (let i = 0; i < 14; i++) {
          newDays[i] = Array.isArray(data.days?.[i]) ? data.days[i] : [];
        }
        state.days = newDays;
        state.holding = Array.isArray(data.holding) ? data.holding : [];
        renderAll();
      }
    });

    window.createTile = function () {
      const id = `tile-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`;
      const tileData = { id, text: "New Activity", color: 0 };
      // Only modify local state, don't mutate DOM
      state.holding.push(tileData);
      syncToFirestore();
    };

    window.addEventListener("DOMContentLoaded", () => {
      renderAll();
    });

  </script>
</head>
<body>
  <div id="calendar" class="calendar"></div>
  <h3>Holding Area</h3>
  <div class="controls">
    <button onclick="createTile()">âž• Create Tile</button>
  </div>
  <div id="holdingArea" class="holding-area">
    <div id="holdingList" class="holding-list"></div>
  </div>
</body>
</html>
